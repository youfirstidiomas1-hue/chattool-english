<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shared English Lab</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --noun: #ff7675; --verb: #55efc4; --adj: #74b9ff; }
        body { margin: 0; background: #1a1a1a; font-family: 'Segoe UI', sans-serif; color: white; }
        #controls { position: sticky; top: 0; background: #2d3436; padding: 15px; z-index: 100; display: flex; gap: 10px; border-bottom: 2px solid #6366f1; }
        button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        #start-btn { background: #6366f1; color: white; }
        #stop-btn { background: #d63031; color: white; }
        #clear-btn { background: #636e72; color: white; }
        #display-area { padding: 20px; display: flex; flex-direction: column-reverse; gap: 10px; max-height: 80vh; overflow-y: auto; }
        .sentence { background: white; color: #2d3436; padding: 15px; border-radius: 15px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .word { cursor: pointer; padding: 2px 5px; border-radius: 4px; border-bottom: 3px solid transparent; font-size: 1.1em; }
        .noun { border-bottom-color: var(--noun); } .verb { border-bottom-color: var(--verb); } .adj { border-bottom-color: var(--adj); }
        .frozen { border: 3px solid #f1c40f !important; background: #fef9e7; }
    </style>
</head>
<body>

<div id="controls">
    <button id="start-btn">üéôÔ∏è Start Class</button>
    <button id="stop-btn">üõë Stop</button>
    <button id="clear-btn">üóëÔ∏è Reset Session</button>
    <div id="status" style="margin-left:auto; align-self:center;">Status: ‚ö™ Ready</div>
</div>

<div id="display-area"></div>

<script>
    // 1. CONFIGURACI√ìN FIREBASE (Usando tus credenciales actuales)
    const firebaseConfig = {
        apiKey: "AIzaSyBeLOoUxemxzjgT2Dk3lDaYhrNkYyouo0M",
        databaseURL: "https://chat-tool-d26fd-default-rtdb.firebaseio.com",
        projectId: "chat-tool-d26fd",
        appId: "1:379784856660:web:75b2f2e49b6b55049199c1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const phrasesRef = db.ref('shared_session/phrases');

    // 2. MOTOR DE VOZ
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = true;
    recognition.interimResults = false;

    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const statusDiv = document.getElementById('status');

    startBtn.onclick = () => {
        try {
            recognition.start();
            statusDiv.innerText = "Status: üî¥ Listening...";
        } catch(e) { console.log("Already running"); }
    };

    stopBtn.onclick = () => {
        recognition.stop();
        statusDiv.innerText = "Status: ‚ö™ Stopped";
    };

    document.getElementById('clear-btn').onclick = () => phrasesRef.remove();

    recognition.onresult = (event) => {
        const text = event.results[event.results.length - 1][0].transcript;
        phrasesRef.push({
            texto: text,
            frozen: false,
            timestamp: Date.now()
        });
    };

    // 3. VISUALIZACI√ìN COMPARTIDA
    phrasesRef.on('value', (snapshot) => {
        const area = document.getElementById('display-area');
        area.innerHTML = '';
        snapshot.forEach((child) => {
            const data = child.val();
            renderSentence(data.texto, child.key, data.frozen);
        });
    });

    function renderSentence(texto, id, isFrozen) {
        const div = document.createElement('div');
        div.className = `sentence ${isFrozen ? 'frozen' : ''}`;
        
        const pin = document.createElement('span');
        pin.innerText = isFrozen ? "üìç" : "üìå";
        pin.style.cursor = "pointer";
        pin.onclick = () => phrasesRef.child(id).update({frozen: !isFrozen});
        div.appendChild(pin);

        texto.split(' ').forEach(w => {
            const span = document.createElement('span');
            span.className = 'word';
            span.innerText = w;
            span.onclick = () => analyzeWord(w, span);
            div.appendChild(span);
        });

        document.getElementById('display-area').appendChild(div);

        if(!isFrozen) {
            setTimeout(() => {
                phrasesRef.child(id).remove();
            }, 60000);
        }
    }

    async function analyzeWord(word, el) {
        const clean = word.toLowerCase().replace(/[^a-z]/g, "");
        const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${clean}`);
        const data = await res.json();
        if(data[0]) {
            const pos = data[0].meanings[0].partOfSpeech;
            const def = data[0].meanings[0].definitions[0].definition;
            el.className = `word ${pos.substring(0,3)}`; // noun, verb, adj
            alert(`[${pos.toUpperCase()}]\n${def}`);
        }
    }
</script>
</body>
</html>