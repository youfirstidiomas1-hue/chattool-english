<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Whereby English Lab</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
   :root {
    --primary: #6366f1;
    --bg: #0f172a;
    --glass: rgba(255, 255, 255, 0.9);
}

body { 
    background-color: var(--bg); 
    color: white; 
    overflow: hidden; 
    font-family: 'Inter', system-ui, sans-serif;
}

/* El contenedor del video ahora es el fondo */
#video-frame { 
    position: absolute;
    top: 0; left: 0;
    width: 100vw; 
    height: 100vh; 
    border: none;
    z-index: 1;
}

/* La barra de estudio ahora flota arriba con estilo moderno */
#study-bar { 
    position: relative;
    z-index: 10;
    height: 140px; 
    background: linear-gradient(to bottom, rgba(15, 23, 42, 0.9), transparent);
    padding: 20px;
    display: flex;
    flex-direction: column-reverse; /* Las nuevas frases aparecen abajo del mic */
    gap: 10px;
    overflow-y: visible;
}

.sentence-row { 
    display: inline-flex;
    align-items: center;
    gap: 8px; 
    padding: 6px 15px; 
    background: var(--glass); 
    backdrop-filter: blur(10px);
    border-radius: 50px; /* Estilo p铆ldora */
    color: #1e293b;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    width: fit-content;
}

.word-btn { 
    cursor: pointer; 
    font-size: 1.1rem;
    padding: 2px 4px;
    border-radius: 4px;
}

.word-btn:hover { 
    background: var(--primary); 
    color: white; 
}

.frozen { 
    background: #fefce8 !important; 
    border: 2px solid #eab308;
    transform: scale(1.05);
}

/* Bot贸n de control flotante */
#controls {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 20;
    background: var(--glass);
    padding: 10px 20px;
    border-radius: 100px;
    display: flex;
    align-items: center;
    gap: 15px;
}
    </style>
</head>
<body>

<div id="controls">
    <button id="start-btn"> Activar Micr贸fono (Ingl茅s)</button>
    <div id="status-mic" class="status-dot"></div>
    <small>Las frases duran 1 min. Haz clic en el  de la frase para congelar.</small>
</div>

<div id="study-bar">
    </div>

<iframe id="video-frame" src="https://whereby.com/coachlaura7" allow="camera; microphone; fullscreen; speaker; display-capture; compute-pressure"></iframe>

<script>
    // 1. CONFIGURACIN DE FIREBASE (Pega tus datos aqu铆)
    const firebaseConfig = {
        apiKey: "TU_API_KEY",
        authDomain: "TU_PROYECTO.firebaseapp.com",
        databaseURL: "https://TU_PROYECTO.firebaseio.com",
        projectId: "TU_PROYECTO",
        storageBucket: "TU_PROYECTO.appspot.com",
        messagingSenderId: "TU_ID",
        appId: "TU_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const frasesRef = db.ref('clase_v1/frases');

    // 2. RECONOCIMIENTO DE VOZ
    const startBtn = document.getElementById('start-btn');
    const statusMic = document.getElementById('status-mic');
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();

    recognition.lang = 'en-US';
    recognition.continuous = true;
    recognition.interimResults = false;

    startBtn.onclick = () => {
        recognition.start();
        statusMic.classList.add('active');
        startBtn.innerText = "Escuchando...";
    };

    recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript;
        // Enviamos a Firebase
        frasesRef.push({
            texto: transcript,
            frozen: false,
            timestamp: Date.now()
        });
    };

    // 3. ESCUCHAR FIREBASE Y RENDERIZAR
    frasesRef.on('child_added', (snapshot) => {
        const data = snapshot.val();
        const id = snapshot.key;
        renderSentence(data.texto, id);
    });

    function renderSentence(texto, id) {
        const container = document.getElementById('study-bar');
        const row = document.createElement('div');
        row.className = 'sentence-row';
        row.id = `row-${id}`;

        // Bot贸n Congelar ()
        const freezeBtn = document.createElement('button');
        freezeBtn.innerText = "";
        freezeBtn.style.marginRight = "10px";
        freezeBtn.onclick = () => row.classList.toggle('frozen');

        row.appendChild(freezeBtn);

        // Palabras clicables
        texto.split(' ').forEach(word => {
            const span = document.createElement('span');
            span.className = 'word-btn';
            span.innerText = word;
            span.onclick = () => getDefinition(word);
            row.appendChild(span);
        });

        container.prepend(row);

        // Auto-eliminaci贸n tras 60 segundos si NO est谩 congelada
        setTimeout(() => {
            const el = document.getElementById(`row-${id}`);
            if (el && !el.classList.contains('frozen')) {
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 1000);
            }
        }, 60000);
    }

    async function getDefinition(word) {
        const cleanWord = word.toLowerCase().replace(/[^a-z]/g, "");
        try {
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${cleanWord}`);
            const data = await res.json();
            if(data[0]) {
                const def = data[0].meanings[0].definitions[0].definition;
                alert(`"${cleanWord.toUpperCase()}":\n\n${def}`);
            }
        } catch(e) { console.error("Error diccionario"); }
    }
</script>
</body>
</html>