<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Lab Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --noun: #ff7675;      /* Rojo suave */
            --verb: #55efc4;      /* Verde */
            --adjective: #74b9ff; /* Azul */
            --adverb: #a29bfe;    /* Morado */
            --other: #dfe6e9;     /* Gris */
        }

        body { margin: 0; background: #000; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        
        /* Contenedor de Frases */
        #tool-layer {
            position: absolute; top: 10px; left: 0; width: 100%; height: 200px;
            z-index: 10; display: flex; flex-direction: column-reverse; 
            align-items: center; gap: 10px; pointer-events: none; /* No bloquea el click al video */
        }

        .sentence {
            pointer-events: auto; background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px; border-radius: 50px; display: flex; gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); animation: fadeIn 0.3s;
        }

        .word-btn { 
            cursor: pointer; padding: 2px 6px; border-radius: 4px; 
            font-weight: bold; border-bottom: 3px solid transparent;
        }
        
        /* Colores por clase */
        .noun { border-bottom-color: var(--noun); }
        .verb { border-bottom-color: var(--verb); }
        .adjective { border-bottom-color: var(--adjective); }
        .adverb { border-bottom-color: var(--adverb); }

        .frozen { background: #fff3cd !important; border: 2px solid #ffc107; }

        /* Controles en Esquinas */
        #mic-btn {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            padding: 12px 20px; border-radius: 10px; border: none;
            background: #6366f1; color: white; cursor: pointer; font-weight: bold;
        }

        #legend {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(0,0,0,0.7); color: white; padding: 10px;
            border-radius: 8px; font-size: 11px; display: flex; flex-direction: column; gap: 4px;
        }

        #whereby-frame { width: 100%; height: 100vh; border: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<button id="mic-btn">üéôÔ∏è Start Listening</button>

<div id="legend">
    <div><span style="color:var(--noun)">‚óè</span> NOUN</div>
    <div><span style="color:var(--verb)">‚óè</span> VERB</div>
    <div><span style="color:var(--adjective)">‚óè</span> ADJECTIVE</div>
</div>

<div id="tool-layer"></div>

<iframe id="whereby-frame" src="https://whereby.com/coachlaura7" allow="camera; microphone; fullscreen; speaker; display-capture"></iframe>

<script>
    // 1. CONFIGURACI√ìN FIREBASE
  const firebaseConfig = {
  apiKey: "AIzaSyBeLOoUxemxzjgT2Dk3lDaYhrNkYyouo0M",
  authDomain: "chat-tool-d26fd.firebaseapp.com",
  databaseURL: "https://chat-tool-d26fd-default-rtdb.firebaseio.com",
  projectId: "chat-tool-d26fd",
  storageBucket: "chat-tool-d26fd.firebasestorage.app",
  messagingSenderId: "379784856660",
  appId: "1:379784856660:web:75b2f2e49b6b55049199c1"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const frasesRef = db.ref('live_session/frases');

    // 2. RECONOCIMIENTO DE VOZ
   const micBtn = document.getElementById('mic-btn');

micBtn.addEventListener('click', () => {
    // Creamos un contexto de audio falso para "despertar" los permisos del navegador
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    if (recognition && recognition.state !== 'listening') {
        try {
            recognition.start();
            micBtn.innerText = "üî¥ Listening...";
            micBtn.style.background = "#ff4757";
            console.log("Speech recognition started successfully");
        } catch (e) {
            console.error("Error starting recognition:", e);
            // Si ya est√° iniciado, no hacemos nada
        }
    }
});

// Listener para errores
recognition.onerror = (event) => {
    console.error("Speech Recognition Error:", event.error);
    if(event.error === 'not-allowed') {
        alert("BLOQUEO DE SEGURIDAD: Haz clic en el candado de la barra de direcciones y permite el MICR√ìFONO.");
    }
    micBtn.innerText = "üéôÔ∏è Retry Mic";
    micBtn.style.background = "#6366f1";
};

    document.getElementById('mic-btn').onclick = () => {
        try {
            recognition.start();
            document.getElementById('mic-btn').innerText = "üî¥ On Air";
            document.getElementById('mic-btn').style.background = "#ff4757";
        } catch (e) { console.log("Ya est√° encendido"); }
    };

    recognition.onresult = (event) => {
        const text = event.results[event.results.length - 1][0].transcript;
        frasesRef.push({ texto: text, timestamp: Date.now() });
    };

    // 3. RECIBIR DE FIREBASE
    frasesRef.on('child_added', (snapshot) => {
        const data = snapshot.val();
        renderSentence(data.texto, snapshot.key);
    });

    // 4. L√ìGICA DE DICCIONARIO Y PART OF SPEECH
    async function renderSentence(texto, id) {
        const row = document.createElement('div');
        row.className = 'sentence';
        row.id = id;

        const words = texto.trim().split(' ');
        
        for (let wordText of words) {
            const span = document.createElement('span');
            span.className = 'word-btn';
            span.innerText = wordText;
            
            // Al hacer clic, buscamos significado y tipo de palabra
            span.onclick = async () => {
                const clean = wordText.toLowerCase().replace(/[^a-z]/g, "");
                const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${clean}`);
                const data = await res.json();
                
                if (data[0]) {
                    const pos = data[0].meanings[0].partOfSpeech; // noun, verb, etc.
                    const def = data[0].meanings[0].definitions[0].definition;
                    
                    // Aplicar color seg√∫n categor√≠a
                    span.classList.add(pos); 
                    alert(`[${pos.toUpperCase()}] ${clean}: ${def}`);
                }
            };
            row.appendChild(span);
        }

        // Bot√≥n pin para congelar
        const pin = document.createElement('button');
        pin.innerText = "üìå";
        pin.style.border = "none"; pin.style.background = "none"; pin.style.cursor = "pointer";
        pin.onclick = () => row.classList.toggle('frozen');
        row.prepend(pin);

        document.getElementById('tool-layer').prepend(row);

        // Auto-borrado
        setTimeout(() => {
            if (!row.classList.contains('frozen')) {
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 1000);
            }
        }, 50000);
    }
</script>
</body>
</html>