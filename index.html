<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shared English Lab</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --noun: #ff7675; --verb: #55efc4; --adj: #74b9ff; }
        body { margin: 0; background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* Capa de Herramienta (Siempre arriba) */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 250px;
            z-index: 100; pointer-events: none; padding: 20px;
            display: flex; flex-direction: column-reverse; align-items: center; gap: 10px;
        }

        .sentence {
            pointer-events: auto; background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px; border-radius: 50px; display: flex; gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .word { cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; }
        .noun { border-bottom-color: var(--noun); }
        .verb { border-bottom-color: var(--verb); }
        .adj { border-bottom-color: var(--adj); }

        /* Controles */
        .controls { position: fixed; top: 20px; left: 20px; z-index: 200; display: flex; gap: 10px; }
        button { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        #start-btn { background: #6366f1; color: white; }
        #stop-btn { background: #fab1a0; }
        #reset-btn { background: #dfe6e9; }

        iframe { width: 100%; height: 100vh; border: none; }
    </style>
</head>
<body>

<div class="controls">
    <button id="start-btn">üéôÔ∏è Start</button>
    <button id="stop-btn">üõë Stop</button>
    <button id="reset-btn">üóëÔ∏è Clear All</button>
</div>

<div id="ui-layer"></div>
<iframe src="https://whereby.com/coachlaura7" allow="camera; microphone; fullscreen"></iframe>

<script>
    // 1. INICIALIZACI√ìN
    const firebaseConfig = {
        apiKey: "AIzaSyBeLOoUxemxzjgT2Dk3lDaYhrNkYyouo0M",
        databaseURL: "https://chat-tool-d26fd-default-rtdb.firebaseio.com",
        projectId: "chat-tool-d26fd",
        appId: "1:379784856660:web:75b2f2e49b6b55049199c1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const sessionRef = db.ref('shared_session');

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.continuous = true;

    // 2. ACCIONES DE BOTONES
    document.getElementById('start-btn').onclick = () => recognition.start();
    document.getElementById('stop-btn').onclick = () => recognition.stop();
    document.getElementById('reset-btn').onclick = () => sessionRef.remove(); // Borra todo de Firebase

    // 3. CAPTURA Y ENV√çO
    recognition.onresult = (event) => {
        const text = event.results[event.results.length - 1][0].transcript;
        sessionRef.child('phrases').push({
            text: text,
            frozen: false,
            timestamp: Date.now()
        });
    };

    // 4. ESCUCHAR CAMBIOS (Sincronizaci√≥n de ambos usuarios)
    sessionRef.child('phrases').on('value', (snapshot) => {
        const container = document.getElementById('ui-layer');
        container.innerHTML = ''; // Limpiamos y redibujamos para mantener sincron√≠a
        
        snapshot.forEach((child) => {
            const data = child.val();
            const id = child.key;
            renderSentence(data.text, id, data.frozen);
        });
    });

    function renderSentence(text, id, isFrozen) {
        const div = document.createElement('div');
        div.className = `sentence ${isFrozen ? 'frozen' : ''}`;
        if(isFrozen) div.style.background = "#fff3cd";

        const pin = document.createElement('span');
        pin.innerText = "üìå";
        pin.style.cursor = "pointer";
        pin.onclick = () => sessionRef.child('phrases').child(id).update({frozen: !isFrozen});
        div.appendChild(pin);

        text.split(' ').forEach(wordStr => {
            const span = document.createElement('span');
            span.className = 'word';
            span.innerText = wordStr;
            span.onclick = () => getGrammar(wordStr, span);
            div.appendChild(span);
        });

        document.getElementById('ui-layer').appendChild(div);

        // Borrado autom√°tico de Firebase si no est√° congelado (60 seg)
        if(!isFrozen) {
            setTimeout(() => {
                sessionRef.child('phrases').child(id).remove();
            }, 60000);
        }
    }

    async function getGrammar(wordStr, element) {
        const clean = wordStr.toLowerCase().replace(/[^a-z]/g, "");
        const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${clean}`);
        const data = await res.json();
        if(data[0]) {
            const pos = data[0].meanings[0].partOfSpeech;
            const def = data[0].meanings[0].definitions[0].definition;
            element.className = `word ${pos.substring(0,3)}`; // Aplica noun, verb, adj
            alert(`[${pos.toUpperCase()}] ${def}`);
        }
    }
</script>
</body>
</html>