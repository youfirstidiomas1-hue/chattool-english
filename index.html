<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Lab Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --noun: #ff7675;      /* Rojo */
            --verb: #55efc4;      /* Verde */
            --adjective: #74b9ff; /* Azul */
            --adverb: #a29bfe;    /* Morado */
            --other: #dfe6e9;
        }

        body { margin: 0; background: #000; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        
        /* Capa de frases: Ahora centrada arriba */
        #tool-layer {
            position: absolute; top: 80px; left: 0; width: 100%; height: 250px;
            z-index: 10; display: flex; flex-direction: column-reverse; 
            align-items: center; gap: 12px; pointer-events: none;
            overflow-y: auto;
        }

        .sentence {
            pointer-events: auto; background: rgba(255, 255, 255, 0.95);
            padding: 12px 25px; border-radius: 50px; display: flex; gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); animation: fadeIn 0.3s;
        }

        .word-btn { 
            cursor: pointer; padding: 2px 6px; border-radius: 4px; 
            font-weight: bold; border-bottom: 3px solid transparent; transition: 0.2s;
        }
        
        /* Colores din√°micos por Part of Speech */
        .noun { border-bottom-color: var(--noun) !important; color: #d63031; }
        .verb { border-bottom-color: var(--verb) !important; color: #00b894; }
        .adjective { border-bottom-color: var(--adjective) !important; color: #0984e3; }
        .adverb { border-bottom-color: var(--adverb) !important; color: #6c5ce7; }

        .frozen { background: #fff3cd !important; border: 2px solid #ffc107; transform: scale(1.02); }

        /* Bot√≥n de Micr√≥fono: Esquina Superior Izquierda */
        #mic-btn {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            padding: 15px 25px; border-radius: 12px; border: none;
            background: #6366f1; color: white; cursor: pointer; font-weight: bold;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4);
        }

        /* Leyenda: Esquina Superior Derecha */
        #legend {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(0,0,0,0.8); color: white; padding: 12px;
            border-radius: 10px; font-size: 12px; display: flex; flex-direction: column; gap: 6px;
        }

        #whereby-frame { width: 100%; height: 100vh; border: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<button id="mic-btn">üéôÔ∏è START CLASS</button>

<div id="legend">
    <div style="font-weight:bold; margin-bottom:4px; border-bottom:1px solid #555;">Grammar Colors:</div>
    <div><span style="color:var(--noun)">‚óè</span> NOUN</div>
    <div><span style="color:var(--verb)">‚óè</span> VERB</div>
    <div><span style="color:var(--adjective)">‚óè</span> ADJECTIVE</div>
    <div><span style="color:var(--adverb)">‚óè</span> ADVERB</div>
</div>

<div id="tool-layer"></div>

<iframe id="whereby-frame" src="https://whereby.com/coachlaura7" allow="camera; microphone; fullscreen; speaker; display-capture"></iframe>

<script>
    // 1. CONFIGURACI√ìN FIREBASE (Mantengo tu configuraci√≥n actual)
    const firebaseConfig = {
        apiKey: "AIzaSyBeLOoUxemxzjgT2Dk3lDaYhrNkYyouo0M",
        authDomain: "chat-tool-d26fd.firebaseapp.com",
        databaseURL: "https://chat-tool-d26fd-default-rtdb.firebaseio.com",
        projectId: "chat-tool-d26fd",
        storageBucket: "chat-tool-d26fd.firebasestorage.app",
        messagingSenderId: "379784856660",
        appId: "1:379784856660:web:75b2f2e49b6b55049199c1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const frasesRef = db.ref('live_session/frases');

    // 2. INICIALIZACI√ìN DE RECONOCIMIENTO (Corregido: Primero definimos, luego usamos)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = true;
    recognition.interimResults = false;

    const micBtn = document.getElementById('mic-btn');

    // Manejador √∫nico para el bot√≥n
    micBtn.addEventListener('click', () => {
        try {
            recognition.start();
            micBtn.innerText = "üî¥ LISTENING...";
            micBtn.style.background = "#ff4757";
        } catch (e) {
            console.log("Mic already active or error:", e);
        }
    });

    recognition.onerror = (event) => {
        console.error("Error:", event.error);
        micBtn.innerText = "üéôÔ∏è RETRY MIC";
        micBtn.style.background = "#6366f1";
    };

    recognition.onresult = (event) => {
        const text = event.results[event.results.length - 1][0].transcript;
        frasesRef.push({ texto: text, timestamp: Date.now() });
    };

    // 3. RECIBIR DE FIREBASE
    frasesRef.on('child_added', (snapshot) => {
        const data = snapshot.val();
        renderSentence(data.texto, snapshot.key);
    });

    // 4. L√ìGICA DE DICCIONARIO Y GRAM√ÅTICA
    async function renderSentence(texto, id) {
        const row = document.createElement('div');
        row.className = 'sentence';
        row.id = id;

        // Bot√≥n Pin (Congelar)
        const pin = document.createElement('span');
        pin.innerText = "üìå";
        pin.style.cursor = "pointer";
        pin.onclick = () => row.classList.toggle('frozen');
        row.appendChild(pin);

        const words = texto.trim().split(' ');
        
        for (let wordText of words) {
            const span = document.createElement('span');
            span.className = 'word-btn';
            span.innerText = wordText;
            
            span.onclick = async () => {
                const clean = wordText.toLowerCase().replace(/[^a-z]/g, "");
                try {
                    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${clean}`);
                    const data = await res.json();
                    
                    if (data[0] && data[0].meanings) {
                        const pos = data[0].meanings[0].partOfSpeech; // noun, verb, etc.
                        const def = data[0].meanings[0].definitions[0].definition;
                        
                        // Limpiar clases previas y aplicar color
                        span.classList.remove('noun', 'verb', 'adjective', 'adverb');
                        span.classList.add(pos); 
                        
                        // Usar un alert informativo
                        alert(`WORD: ${clean.toUpperCase()}\nTYPE: ${pos.toUpperCase()}\n\nDEFINITION: ${def}`);
                    }
                } catch (e) {
                    console.error("Dictionary error:", e);
                }
            };
            row.appendChild(span);
        }

        document.getElementById('tool-layer').prepend(row);

        // Auto-borrado a los 50 segundos
        setTimeout(() => {
            if (!row.classList.contains('frozen')) {
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 1000);
            }
        }, 50000);
    }
</script>
</body>
</html>