<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Lab Standalone</title>
    <style>
        body { background: #1a011f; color: white; font-family: sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; display: grid; gap: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .status { font-size: 12px; padding: 5px 10px; border-radius: 20px; background: #333; }
        .online { color: #00ffcc; border: 1px solid #00ffcc; }
        
        .main-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; height: 70vh; }
        .chat-box { background: rgba(255,255,255,0.05); border-radius: 15px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; }
        #scroll-area { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .phrase-row { font-size: 24px; line-height: 1.4; transition: 0.2s; }
        .remote { color: #af8b4a; border-left: 4px solid #af8b4a; padding-left: 15px; }
        .local { color: #eeeeee; }
        .word-span { cursor: pointer; padding: 2px 4px; border-radius: 4px; }
        .word-span:hover { background: rgba(0, 255, 204, 0.2); color: #00ffcc; }

        .dict-panel { background: rgba(255,255,255,0.08); border-radius: 15px; border: 1px solid #444; padding: 20px; }
        #dict-word { color: #00ffcc; font-size: 1.5em; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #444; }
        .entry { margin-bottom: 12px; font-size: 14px; }
        .pos { color: #00ffcc; font-size: 10px; font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div><strong>ENGLISH LAB</strong> | Mirroring Active</div>
        <div id="conn-status" class="status">Connecting to Firebase...</div>
    </div>

    <div class="main-layout">
        <div class="chat-box">
            <div id="scroll-area">
                </div>
        </div>

        <div class="dict-panel">
            <div id="dict-word">DICTIONARY</div>
            <div id="dict-results">Click any word in the chat to see definitions.</div>
        </div>
    </div>
</div>

<script>
    // CONFIGURACIÓN
    const DB_URL = "https://chat-tool-d26fd-default-rtdb.firebaseio.com/live_session.json";
    const myID = "USER_" + Math.random().toString(36).substring(7);
    let lastTimestamp = 0;

    const scrollArea = document.getElementById('scroll-area');
    const statusTag = document.getElementById('conn-status');

    // 1. FUNCIÓN PARA ENVIAR A FIREBASE
    async function pushData(text, type, extra = null) {
        const payload = { text, type, sender: myID, timestamp: Date.now(), extra };
        try {
            await fetch(DB_URL, {
                method: 'PATCH',
                body: JSON.stringify({ "lastEvent": payload })
            });
            renderMessage(payload, false);
        } catch (e) { console.error("Send Error", e); }
    }

    // 2. BUCLE DE ESCUCHA (MIRRORING)
    async function startMirroring() {
        setInterval(async () => {
            try {
                const res = await fetch(DB_URL);
                const data = await res.json();
                statusTag.innerText = "● SYSTEM ONLINE";
                statusTag.className = "status online";

                if (data && data.lastEvent) {
                    const ev = data.lastEvent;
                    if (ev.timestamp > lastTimestamp && ev.sender !== myID) {
                        lastTimestamp = ev.timestamp;
                        renderMessage(ev, true);
                    }
                }
            } catch (e) { 
                statusTag.innerText = "○ RECONNECTING...";
                statusTag.className = "status";
            }
        }, 1500);
    }

    // 3. RENDERIZAR EN PANTALLA
    function renderMessage(data, isRemote) {
        if (data.type === 'phrase') {
            const row = document.createElement('div');
            row.className = `phrase-row ${isRemote ? 'remote' : 'local'}`;
            
            data.text.split(" ").forEach(word => {
                const span = document.createElement('span');
                span.className = 'word-span';
                span.innerText = word + " ";
                span.onclick = () => lookupWord(word);
                row.appendChild(span);
            });

            scrollArea.appendChild(row);
            scrollArea.scrollTop = scrollArea.scrollHeight;
        } else if (data.type === 'analysis') {
            updateDictUI(data.text, data.extra);
        }
    }

    // 4. DICCIONARIO
    async function lookupWord(word) {
        const cleanWord = word.toLowerCase().replace(/[^a-z]/g, '');
        try {
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${cleanWord}`);
            const data = await res.json();
            if (data && data[0]) {
                const entries = data[0].meanings.map(m => ({
                    pos: m.partOfSpeech,
                    def: m.definitions[0].definition
                }));
                pushData(cleanWord, 'analysis', entries);
            }
        } catch (e) { console.log("Dict error"); }
    }

    function updateDictUI(word, entries) {
        document.getElementById('dict-word').innerText = word.toUpperCase();
        const container = document.getElementById('dict-results');
        container.innerHTML = entries.map(e => `
            <div class="entry">
                <div class="pos">${e.pos}</div>
                <div>${e.def}</div>
            </div>
        `).join('');
    }

    // 5. RECONOCIMIENTO DE VOZ
    function initSpeech() {
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Speech) {
            alert("Speech recognition not supported in this browser. Use Chrome.");
            return;
        }
        const rec = new Speech();
        rec.lang = 'en-US';
        rec.continuous = true;
        rec.interimResults = false;

        rec.onresult = (event) => {
            const text = event.results[event.results.length - 1][0].transcript.trim();
            pushData(text, 'phrase');
        };

        rec.onend = () => rec.start();
        rec.start();
    }

    // INICIO
    startMirroring();
    initSpeech();
</script>

</body>
</html>