<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Whereby English Lab</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f0f2f5; }
        
        /* Barra superior de estudio */
        #study-bar { height: 180px; background: white; border-bottom: 2px solid #ddd; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        .sentence-row { display: flex; flex-wrap: wrap; gap: 6px; padding: 10px; background: #e9ecef; border-radius: 8px; border-left: 5px solid #007bff; animation: slideIn 0.3s ease; }
        
        .word-btn { cursor: pointer; padding: 4px 8px; background: white; border: 1px solid #ccc; border-radius: 4px; font-weight: 500; transition: 0.2s; }
        .word-btn:hover { background: #007bff; color: white; }
        
        .frozen { border: 2px solid #ffc107 !important; background: #fff3cd !important; box-shadow: 0 0 10px rgba(255,193,7,0.3); }

        /* Contenedor de Video */
        #video-frame { flex-grow: 1; border: none; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        #controls { padding: 5px 15px; background: #eee; display: flex; gap: 10px; align-items: center; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: red; }
        .active { background: #28a745; }
    </style>
</head>
<body>

<div id="controls">
    <button id="start-btn">ðŸŽ¤ Activar MicrÃ³fono (InglÃ©s)</button>
    <div id="status-mic" class="status-dot"></div>
    <small>Las frases duran 1 min. Haz clic en el ðŸ“Œ de la frase para congelar.</small>
</div>

<div id="study-bar">
    </div>

<iframe id="video-frame" src="https://whereby.com/coachlaura7" allow="camera; microphone; fullscreen; speaker; display-capture; compute-pressure"></iframe>

<script>
    // 1. CONFIGURACIÃ“N DE FIREBASE (Pega tus datos aquÃ­)
    const firebaseConfig = {
        apiKey: "TU_API_KEY",
        authDomain: "TU_PROYECTO.firebaseapp.com",
        databaseURL: "https://TU_PROYECTO.firebaseio.com",
        projectId: "TU_PROYECTO",
        storageBucket: "TU_PROYECTO.appspot.com",
        messagingSenderId: "TU_ID",
        appId: "TU_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const frasesRef = db.ref('clase_v1/frases');

    // 2. RECONOCIMIENTO DE VOZ
    const startBtn = document.getElementById('start-btn');
    const statusMic = document.getElementById('status-mic');
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();

    recognition.lang = 'en-US';
    recognition.continuous = true;
    recognition.interimResults = false;

    startBtn.onclick = () => {
        recognition.start();
        statusMic.classList.add('active');
        startBtn.innerText = "Escuchando...";
    };

    recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript;
        // Enviamos a Firebase
        frasesRef.push({
            texto: transcript,
            frozen: false,
            timestamp: Date.now()
        });
    };

    // 3. ESCUCHAR FIREBASE Y RENDERIZAR
    frasesRef.on('child_added', (snapshot) => {
        const data = snapshot.val();
        const id = snapshot.key;
        renderSentence(data.texto, id);
    });

    function renderSentence(texto, id) {
        const container = document.getElementById('study-bar');
        const row = document.createElement('div');
        row.className = 'sentence-row';
        row.id = `row-${id}`;

        // BotÃ³n Congelar (ðŸ“Œ)
        const freezeBtn = document.createElement('button');
        freezeBtn.innerText = "ðŸ“Œ";
        freezeBtn.style.marginRight = "10px";
        freezeBtn.onclick = () => row.classList.toggle('frozen');

        row.appendChild(freezeBtn);

        // Palabras clicables
        texto.split(' ').forEach(word => {
            const span = document.createElement('span');
            span.className = 'word-btn';
            span.innerText = word;
            span.onclick = () => getDefinition(word);
            row.appendChild(span);
        });

        container.prepend(row);

        // Auto-eliminaciÃ³n tras 60 segundos si NO estÃ¡ congelada
        setTimeout(() => {
            const el = document.getElementById(`row-${id}`);
            if (el && !el.classList.contains('frozen')) {
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 1000);
            }
        }, 60000);
    }

    async function getDefinition(word) {
        const cleanWord = word.toLowerCase().replace(/[^a-z]/g, "");
        try {
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${cleanWord}`);
            const data = await res.json();
            if(data[0]) {
                const def = data[0].meanings[0].definitions[0].definition;
                alert(`"${cleanWord.toUpperCase()}":\n\n${def}`);
            }
        } catch(e) { console.error("Error diccionario"); }
    }
</script>
</body>
</html>